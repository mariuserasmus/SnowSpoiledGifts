{% extends "base.html" %}

{% block title %}Candles & Soaps Products - Admin - {{ config.SITE_NAME }}{% endblock %}

{% block content %}
<section class="admin-section">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-spa"></i> Candles & Soaps</h2>
                    <div>
                        <a href="{{ url_for('admin_candles_soaps_categories') }}" class="btn btn-outline-purple me-2">
                            <i class="fas fa-tag"></i> Manage Categories
                        </a>
                        <a href="{{ url_for('admin_add_candles_soaps_product') }}" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add New Item
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card candles-gradient">
                    <div class="stats-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ products|length }}</h3>
                        <p>Total Products</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card candles-gradient">
                    <div class="stats-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ products|selectattr('stock_quantity', 'gt', 0)|list|length }}</h3>
                        <p>In Stock</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                    <div class="stats-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ low_stock_products|length }}</h3>
                        <p>Low Stock</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);">
                    <div class="stats-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stats-content">
                        <h3>{{ products|selectattr('stock_quantity', 'equalto', 0)|list|length }}</h3>
                        <p>Out of Stock</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <form method="GET" class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Category</label>
                                <select name="category_id" class="form-select">
                                    <option value="">All Categories</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" {% if request.args.get('category_id') == category.id|string %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Stock Status</label>
                                <select name="stock_status" class="form-select">
                                    <option value="">All Products</option>
                                    <option value="in_stock" {% if request.args.get('stock_status') == 'in_stock' %}selected{% endif %}>In Stock</option>
                                    <option value="low_stock" {% if request.args.get('stock_status') == 'low_stock' %}selected{% endif %}>Low Stock</option>
                                    <option value="out_of_stock" {% if request.args.get('stock_status') == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Search</label>
                                <input type="text" name="search" class="form-control" placeholder="Search by name or product code..." value="{{ request.args.get('search', '') }}">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="row">
            {% if products %}
                {% for product in products %}
                <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
                    <div class="card h-100 product-card">
                        <div class="product-image-container">
                            {% if product.main_photo %}
                            <img src="/{{ product.main_photo }}" class="card-img-top" alt="{{ product.name }}" onerror="this.parentElement.innerHTML='<div class=\'no-image-placeholder\'><i class=\'fas fa-image fa-3x\'></i><p>No Photo</p></div>'">
                            {% else %}
                            <div class="no-image-placeholder">
                                <i class="fas fa-image fa-3x"></i>
                                <p>No Photo</p>
                            </div>
                            {% endif %}
                            <div class="product-code-badge">{{ product.product_code }}</div>

                            <!-- Stock Status Badge -->
                            {% if product.stock_quantity == 0 %}
                            <div class="stock-badge out-of-stock">
                                <i class="fas fa-times-circle"></i> Out of Stock
                            </div>
                            {% elif product.stock_quantity <= product.low_stock_threshold %}
                            <div class="stock-badge low-stock">
                                <i class="fas fa-exclamation-triangle"></i> Low Stock
                            </div>
                            {% else %}
                            <div class="stock-badge in-stock">
                                <i class="fas fa-check-circle"></i> In Stock
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ product.name }}</h5>
                            <p class="card-text text-muted small">{{ product.description[:80] if product.description else '' }}{% if product.description and product.description|length > 80 %}...{% endif %}</p>

                            <div class="product-meta mb-2">
                                <span class="badge bg-purple">{{ product.category_name or 'No Category' }}</span>
                            </div>

                            <div class="product-details mb-3">
                                <p class="mb-1"><strong>Price:</strong> R{{ "%.2f"|format(product.price) }}</p>
                                <p class="mb-1">
                                    <strong>Stock:</strong>
                                    <span class="{% if product.stock_quantity == 0 %}text-danger{% elif product.stock_quantity <= product.low_stock_threshold %}text-warning{% else %}text-success{% endif %}">
                                        {{ product.stock_quantity }} units
                                    </span>
                                    <span class="text-muted small">(threshold: {{ product.low_stock_threshold }})</span>
                                </p>
                                {% if product.scent %}
                                <p class="mb-1"><strong>Scent:</strong> {{ product.scent }}</p>
                                {% endif %}
                                {% if product.weight_grams %}
                                <p class="mb-1"><strong>Weight:</strong> {{ product.weight_grams }}g</p>
                                {% endif %}
                            </div>

                            <div class="mt-auto d-flex justify-content-center align-items-center">
                                <a href="{{ url_for('admin_edit_candles_soaps_product', product_id=product.id) }}" class="btn btn-link text-warning p-0 me-3" title="Edit Item" style="text-decoration: none; cursor: pointer;">
                                    <i class="fas fa-edit fa-lg"></i>
                                </a>
                                <button type="button" class="btn btn-link text-info p-0 me-3" title="Adjust Stock" onclick="showStockModal({{ product.id }}, '{{ product.name }}', {{ product.stock_quantity }})" style="text-decoration: none; cursor: pointer;">
                                    <i class="fas fa-boxes fa-lg"></i>
                                </button>
                                <form method="POST" action="{{ url_for('admin_delete_candles_soaps_product', product_id=product.id) }}" onsubmit="return confirm('Are you sure you want to delete this item?');" style="display: inline;">
                                    <button type="submit" class="btn btn-link text-danger p-0" title="Delete Item" style="text-decoration: none; cursor: pointer;">
                                        <i class="fas fa-trash fa-lg"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <h4>No items found</h4>
                        <p>Start by adding your first item!</p>
                        <a href="{{ url_for('admin_add_candles_soaps_product') }}" class="btn btn-primary mt-2">
                            <i class="fas fa-plus"></i> Add New Item
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Stock Adjustment Modal -->
<div class="modal fade" id="stockModal" tabindex="-1" aria-labelledby="stockModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="stockForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="stockModalLabel">Adjust Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Product:</strong> <span id="stockProductName"></span><br>
                        <strong>Current Stock:</strong> <span id="stockCurrentQty"></span> units
                    </div>

                    <div class="mb-3">
                        <label for="stockChangeAmount" class="form-label">Change Amount <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="stockChangeAmount" name="change_amount" required onchange="updateNewStock()">
                        <small class="form-text text-muted">Use positive numbers to add stock, negative to reduce</small>
                    </div>

                    <div class="mb-3">
                        <label for="stockReason" class="form-label">Reason <span class="text-danger">*</span></label>
                        <select class="form-select" id="stockReason" name="reason" required>
                            <option value="">Select a reason...</option>
                            <option value="Restock">Restock</option>
                            <option value="Damage">Damage</option>
                            <option value="Manual Adjustment">Manual Adjustment</option>
                            <option value="Inventory Count">Inventory Count</option>
                            <option value="Return">Return</option>
                            <option value="Correction">Correction</option>
                        </select>
                    </div>

                    <div class="alert alert-secondary">
                        <strong>New Stock Level:</strong> <span id="stockNewQty">-</span> units
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Stock</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.admin-section {
    padding: 100px 20px 60px;
    min-height: 100vh;
    background: var(--bg-color);
}

.stats-card {
    color: white !important;
}

.stats-card * {
    color: white !important;
}

.product-card {
    transition: transform 0.2s;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.product-image-container {
    position: relative;
    height: 250px;
    overflow: hidden;
    background: #f5f5f5;
}

.product-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.no-image-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #999;
}

.product-code-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(147, 51, 234, 0.9);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.75rem;
    font-weight: bold;
}

.stock-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.75rem;
    font-weight: bold;
}

.stock-badge.in-stock {
    background: rgba(34, 197, 94, 0.9);
    color: white;
}

.stock-badge.low-stock {
    background: rgba(245, 158, 11, 0.9);
    color: white;
}

.stock-badge.out-of-stock {
    background: rgba(220, 38, 38, 0.9);
    color: white;
}

.stats-card {
    border-radius: 15px;
    padding: 25px;
    color: white;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    margin-bottom: 20px;
}

.candles-gradient {
    background: linear-gradient(135deg, #9333ea 0%, #c084fc 100%);
}

.stats-icon {
    font-size: 3rem;
    margin-right: 20px;
    opacity: 0.8;
}

.stats-content h3 {
    font-size: 2.5rem;
    margin: 0;
    font-weight: bold;
}

.stats-content p {
    margin: 0;
    opacity: 0.9;
}

.badge.bg-purple {
    background-color: #9333ea !important;
}

.btn-outline-purple {
    color: #9333ea;
    border-color: #9333ea;
}

.btn-outline-purple:hover {
    background-color: #9333ea;
    border-color: #9333ea;
    color: white;
}

.product-meta {
    margin-top: auto;
}

.product-details {
    font-size: 0.875rem;
}

/* Override the purple candles gradient on regular cards */
.card:not(.stats-card) {
    background: var(--card-bg) !important;
    color: var(--text-color) !important;
    border: none;
}

.card:not(.stats-card) .card-body {
    background: var(--card-bg) !important;
    color: var(--text-color) !important;
}

.product-card {
    background: var(--card-bg) !important;
    color: var(--text-color) !important;
}

.product-card .card-body {
    background: var(--card-bg) !important;
    color: var(--text-color) !important;
}

.form-label,
label {
    color: var(--text-color) !important;
}

/* Dark mode handled by global style.css with [data-theme="dark"] */

[data-bs-theme="dark"] .alert-secondary {
    background-color: #374151;
    border-color: #4b5563;
    color: #d1d5db;
}
</style>

<script>
let currentProductId = null;
let currentStock = 0;

function showStockModal(productId, productName, stockQuantity) {
    currentProductId = productId;
    currentStock = stockQuantity;

    document.getElementById('stockProductName').textContent = productName;
    document.getElementById('stockCurrentQty').textContent = stockQuantity;
    document.getElementById('stockChangeAmount').value = '';
    document.getElementById('stockReason').value = '';
    document.getElementById('stockNewQty').textContent = '-';

    document.getElementById('stockForm').action = `/admin/candles-soaps/products/${productId}/stock/adjust`;

    const modal = new bootstrap.Modal(document.getElementById('stockModal'));
    modal.show();
}

function updateNewStock() {
    const changeAmount = parseInt(document.getElementById('stockChangeAmount').value) || 0;
    const newStock = currentStock + changeAmount;
    document.getElementById('stockNewQty').textContent = newStock;

    // Color code the new stock
    const stockNewQtyElement = document.getElementById('stockNewQty');
    if (newStock < 0) {
        stockNewQtyElement.style.color = '#dc2626';
        stockNewQtyElement.parentElement.parentElement.classList.remove('alert-secondary');
        stockNewQtyElement.parentElement.parentElement.classList.add('alert-danger');
    } else {
        stockNewQtyElement.style.color = '';
        stockNewQtyElement.parentElement.parentElement.classList.remove('alert-danger');
        stockNewQtyElement.parentElement.parentElement.classList.add('alert-secondary');
    }
}
</script>
{% endblock %}
